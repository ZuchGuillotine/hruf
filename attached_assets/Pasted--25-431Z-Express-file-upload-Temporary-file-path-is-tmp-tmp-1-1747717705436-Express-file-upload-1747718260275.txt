:25.431Z' }
Express-file-upload: Temporary file path is /tmp/tmp-1-1747717705436
Express-file-upload: Opening write stream for file->1742899618198-MyChart-TestDetails.pdf...
Express-file-upload: New upload started file->1742899618198-MyChart-TestDetails.pdf, bytes:0
Express-file-upload: Uploading file->1742899618198-MyChart-TestDetails.pdf, bytes:8022...
Express-file-upload: Uploading file->1742899618198-MyChart-TestDetails.pdf, bytes:13910...
Express-file-upload: Uploading file->1742899618198-MyChart-TestDetails.pdf, bytes:16214...
Express-file-upload: Uploading file->1742899618198-MyChart-TestDetails.pdf, bytes:32598...
Express-file-upload: Uploading file->1742899618198-MyChart-TestDetails.pdf, bytes:40790...
Express-file-upload: Uploading file->1742899618198-MyChart-TestDetails.pdf, bytes:48982...
Express-file-upload: Uploading file->1742899618198-MyChart-TestDetails.pdf, bytes:57174...
Express-file-upload: Uploading file->1742899618198-MyChart-TestDetails.pdf, bytes:93948...
Express-file-upload: Upload finished file->1742899618198-MyChart-TestDetails.pdf, bytes:93948
Express-file-upload: Upload file->1742899618198-MyChart-TestDetails.pdf completed, bytes:93948.
Express-file-upload: Busboy finished parsing request.
Express-file-upload: Moving temporary file /tmp/tmp-1-1747717705436 to /home/runner/workspace/uploads/1747717705518-1742899618198-MyChart-TestDetails.pdf
info: File moved to /home/runner/workspace/uploads/1747717705518-1742899618198-MyChart-TestDetails.pdf {"timestamp":"2025-05-20T05:08:25.520Z"}
info: Starting lab text preprocessing {"bufferSize":93948,"mimeType":"application/pdf","timestamp":"2025-05-20T05:08:25.521Z"}
Warning: getTextContent - ignoring errors during task: GetTextContent: page 0
Warning: getTextContent - ignoring errors during task: GetTextContent: page 1
Warning: getTextContent - ignoring errors during task: GetTextContent: page 2
Warning: getTextContent - ignoring errors during task: GetTextContent: page 0
info: PDF text extraction successful with basic pdf-parse {"method":"pdf-parse-basic","pageCount":3,"textLength":2507,"timestamp":"2025-05-20T05:08:25.692Z"}
info: Text normalization complete {"originalFormat":"pdf","processingSteps":["reflow_columns","basic_cleanup","remove_headers_footers","standardize_phrases","fix_ocr_errors","final_cleanup"],"processingTime":3,"qualityMetrics":{"medicalTermCount":0,"numericRatio":0,"numericValueCount":0,"overallQualityScore":0,"potentialOcrErrors":0,"specialCharRatio":0,"unitConsistencyScore":0,"whitespaceRatio":0},"textLength":0,"timestamp":"2025-05-20T05:08:25.696Z"}
info: Lab text preprocessing complete {"mimeType":"application/pdf","processingSteps":["reflow_columns","basic_cleanup","remove_headers_footers","standardize_phrases","fix_ocr_errors","final_cleanup"],"textLength":0,"timestamp":"2025-05-20T05:08:25.698Z"}
info: Lab text pre-processing complete {"fileName":"1742899618198-MyChart-TestDetails.pdf","mimeType":"application/pdf","qualityMetrics":{"numericRatio":0,"potentialOcrErrors":0,"specialCharRatio":0,"whitespaceRatio":0},"textLength":0,"timestamp":"2025-05-20T05:08:25.698Z"}
info: Lab result saved: {"fileName":"1742899618198-MyChart-TestDetails.pdf","fileSize":93948,"fileUrl":"/uploads/1747717705518-1742899618198-MyChart-TestDetails.pdf","hasPreprocessedText":true,"labId":99,"timestamp":"2025-05-20T05:08:25.736Z","userId":1}
info: Background summary generation started for lab ID: {"timestamp":"2025-05-20T05:08:25.737Z"}
info: Processing PDF file: /home/runner/workspace/uploads/1747717705518-1742899618198-MyChart-TestDetails.pdf {"fileName":"1742899618198-MyChart-TestDetails.pdf","fileSize":93948,"timestamp":"2025-05-20T05:08:25.769Z"}
info: Starting regex extraction with text: {"patterns":["cholesterol","hdl","ldl","triglycerides","glucose","hemoglobinA1c","insulin","sodium","potassium","chloride","co2","anionGap","tsh","t4","t3","vitaminD","vitaminB12","folate","ferritin","iron","magnesium","hemoglobin","hematocrit","platelets","alt","ast","alkalinePhosphatase","creatinine","bun","egfr","cortisol","testosterone","estradiol"],"textLength":2507,"textSample":"\n\nName: Benjamin Gregg Cox | DOB: 2/5/1988 | MRN: 1000237659 | PCP: Richard J St Cyr, MD | Legal Name: Benjamin Gregg Cox\nResults\nCOMPREHENSIVE METABOLIC PANEL\nCollected on Jan 07, 2023 10:52 AM\nNew\nSodium\nNormal range: 136 - 145 mmol/L\n136145\n138\nPotassium\nNormal range: 3.5 - 5.1 mmol/L\n3.55.1\n3.4Low\nChloride\nNormal range: 98 - 107 mmol/L\n98107\n100\nCO2,Total\nNormal range: 20 - 31 mmol/L\n2031\n26\nAnion Gap\nNormal range: 5 - 16 mmol/L\n516\n12\nGlucose\nNormal range: 74 - 106 mg/dL\n74106\n256High\nCalci","timestamp":"2025-05-20T05:08:25.807Z"}
info: Found test date with regex: {"date":"2023-01-07T00:00:00.000Z","pattern":"/(?:Date|Collection Date|Report Date|Test Date):\\s*(\\w+\\s+\\d{1,2},?\\s+\\d{4})/i","timestamp":"2025-05-20T05:08:25.808Z"}
info: Successfully validated biomarker: {"biomarker":"glucose","status":"Low","timestamp":"2025-05-20T05:08:25.811Z","unit":"mg/dL","value":74106}
warn: Low regex recall detected: {"expectedBiomarkers":33,"foundBiomarkers":1,"recallPercentage":3.0303030303030303,"sampleText":"\n\nName: Benjamin Gregg Cox | DOB: 2/5/1988 | MRN: 100 0237659 | PCP: Richard J St Cyr, MD | Legal Name: Benjamin Gregg Cox\nResults\nCOMPREHENSIVE METABOLIC PANEL\nCollected on Jan 07, 2023 10:52 AM\nNew\n","textLength":2516,"timestamp":"2025-05-20T05:08:25.819Z","totalMatches":1,"validationFailures":0}
info: Regex extraction complete: {"biomarkersFound":["glucose"],"recallPercentage":3.0303030303030303,"successfulExtractions":1,"timestamp":"2025-05-20T05:08:25.819Z","totalMatches":1,"validationFailures":0}
info: Starting LLM extraction with text length: {"textLength":3124,"timestamp":"2025-05-20T05:08:25.820Z"}
User deserialized: { userId: 1, timestamp: '2025-05-20T05:08:25.866Z' }
User deserialized: { userId: 1, timestamp: '2025-05-20T05:08:25.902Z' }
info: Retrieved 3 lab results for user 1 {"timestamp":"2025-05-20T05:08:25.966Z"}
info: LLM extraction extracted biomarkers: {"count":21,"firstBiomarker":"Sodium: 138 mmol/L","timestamp":"2025-05-20T05:08:35.968Z"}
warn: Failed to validate LLM biomarker: {"biomarker":"BUN/Creatinine Ratio","error":"[\n  {\n    \"code\": \"too_small\",\n    \"minimum\": 1,\n    \"type\": \"string\",\n    \"inclusive\": true,\n    \"exact\": false,\n    \"message\": \"String must contain at least 1 character(s)\",\n    \"path\": [\n      \"unit\"\n    ]\n  }\n]","issues":[{"code":"too_small","exact":false,"inclusive":true,"message":"String must contain at least 1 character(s)","minimum":1,"path":["unit"],"type":"string"}],"timestamp":"2025-05-20T05:08:35.971Z"}
warn: Failed to validate LLM biomarker: {"biomarker":"A/G Ratio","error":"[\n  {\n    \"code\": \"too_small\",\n    \"minimum\": 1,\n    \"type\": \"string\",\n    \"inclusive\": true,\n    \"exact\": false,\n    \"message\": \"String must contain at least 1 character(s)\",\n    \"path\": [\n      \"unit\"\n    ]\n  }\n]","issues":[{"code":"too_small","exact":false,"inclusive":true,"message":"String must contain at least 1 character(s)","minimum":1,"path":["unit"],"type":"string"}],"timestamp":"2025-05-20T05:08:35.973Z"}
info: LLM extraction validation complete: {"originalCount":21,"timestamp":"2025-05-20T05:08:35.973Z","validCount":19}
info: Starting pattern extraction with enhanced matching {"patternCount":3,"textLength":2507,"timestamp":"2025-05-20T05:08:35.974Z"}
info: Pattern extraction complete {"biomarkersFound":[],"timestamp":"2025-05-20T05:08:35.975Z","totalMatches":0,"uniqueMatches":0}
info: Extracted biomarkers for lab result 99 {"biomarkerCount":19,"timestamp":"2025-05-20T05:08:35.979Z"}
info: Starting regex extraction with text: {"patterns":["cholesterol","hdl","ldl","triglycerides","glucose","hemoglobinA1c","insulin","sodium","potassium","chloride","co2","anionGap","tsh","t4","t3","vitaminD","vitaminB12","folate","ferritin","iron","magnesium","hemoglobin","hematocrit","platelets","alt","ast","alkalinePhosphatase","creatinine","bun","egfr","cortisol","testosterone","estradiol"],"textLength":2507,"textSample":"\n\nName: Benjamin Gregg Cox | DOB: 2/5/1988 | MRN: 1000237659 | PCP: Richard J St Cyr, MD | Legal Name: Benjamin Gregg Cox\nResults\nCOMPREHENSIVE METABOLIC PANEL\nCollected on Jan 07, 2023 10:52 AM\nNew\nSodium\nNormal range: 136 - 145 mmol/L\n136145\n138\nPotassium\nNormal range: 3.5 - 5.1 mmol/L\n3.55.1\n3.4Low\nChloride\nNormal range: 98 - 107 mmol/L\n98107\n100\nCO2,Total\nNormal range: 20 - 31 mmol/L\n2031\n26\nAnion Gap\nNormal range: 5 - 16 mmol/L\n516\n12\nGlucose\nNormal range: 74 - 106 mg/dL\n74106\n256High\nCalci","timestamp":"2025-05-20T05:08:36.138Z"}
info: Found test date with regex: {"date":"2023-01-07T00:00:00.000Z","pattern":"/(?:Date|Collection Date|Report Date|Test Date):\\s*(\\w+\\s+\\d{1,2},?\\s+\\d{4})/i","timestamp":"2025-05-20T05:08:36.138Z"}
info: Successfully validated biomarker: {"biomarker":"glucose","status":"Low","timestamp":"2025-05-20T05:08:36.139Z","unit":"mg/dL","value":74106}
warn: Low regex recall detected: {"expectedBiomarkers":33,"foundBiomarkers":1,"recallPercentage":3.0303030303030303,"sampleText":"\n\nName: Benjamin Gregg Cox | DOB: 2/5/1988 | MRN: 100 0237659 | PCP: Richard J St Cyr, MD | Legal Name: Benjamin Gregg Cox\nResults\nCOMPREHENSIVE METABOLIC PANEL\nCollected on Jan 07, 2023 10:52 AM\nNew\n","textLength":2516,"timestamp":"2025-05-20T05:08:36.140Z","totalMatches":1,"validationFailures":0}
info: Regex extraction complete: {"biomarkersFound":["glucose"],"recallPercentage":3.0303030303030303,"successfulExtractions":1,"timestamp":"2025-05-20T05:08:36.140Z","totalMatches":1,"validationFailures":0}
info: Starting LLM extraction with text length: {"textLength":3124,"timestamp":"2025-05-20T05:08:36.140Z"}
info: LLM extraction extracted biomarkers: {"count":20,"firstBiomarker":"Sodium: 138 mmol/L","timestamp":"2025-05-20T05:08:44.772Z"}
warn: Failed to validate LLM biomarker: {"biomarker":"BUN/Creatinine Ratio","error":"[\n  {\n    \"code\": \"too_small\",\n    \"minimum\": 1,\n    \"type\": \"string\",\n    \"inclusive\": true,\n    \"exact\": false,\n    \"message\": \"String must contain at least 1 character(s)\",\n    \"path\": [\n      \"unit\"\n    ]\n  }\n]","issues":[{"code":"too_small","exact":false,"inclusive":true,"message":"String must contain at least 1 character(s)","minimum":1,"path":["unit"],"type":"string"}],"timestamp":"2025-05-20T05:08:44.774Z"}
warn: Failed to validate LLM biomarker: {"biomarker":"A/G Ratio","error":"[\n  {\n    \"code\": \"too_small\",\n    \"minimum\": 1,\n    \"type\": \"string\",\n    \"inclusive\": true,\n    \"exact\": false,\n    \"message\": \"String must contain at least 1 character(s)\",\n    \"path\": [\n      \"unit\"\n    ]\n  }\n]","issues":[{"code":"too_small","exact":false,"inclusive":true,"message":"String must contain at least 1 character(s)","minimum":1,"path":["unit"],"type":"string"}],"timestamp":"2025-05-20T05:08:44.774Z"}
info: LLM extraction validation complete: {"originalCount":20,"timestamp":"2025-05-20T05:08:44.775Z","validCount":18}
info: Starting pattern extraction with enhanced matching {"patternCount":3,"textLength":2507,"timestamp":"2025-05-20T05:08:44.775Z"}
info: Pattern extraction complete {"biomarkersFound":[],"timestamp":"2025-05-20T05:08:44.775Z","totalMatches":0,"uniqueMatches":0}
info: Extracted 19 biomarkers from lab result 99 {"biomarkers":["glucose","Sodium","Potassium","Chloride","CO2, Total","Anion Gap","Calcium","BUN","Creatinine","GFR if African American","GFR if not African American","Osmolality, Calculated","Protein, Total","Albumin","Globulin","Bilirubin, Total","Alkaline Phosphatase","ALT (SGPT)","AST (SGOT)"],"llmCount":18,"processingTime":8797,"regexCount":1,"timestamp":"2025-05-20T05:08:44.777Z"}
info: Starting biomarker storage transaction {"biomarkerCount":19,"labResultId":99,"timestamp":"2025-05-20T05:08:44.781Z"}
error: Error processing biomarkers for lab result 99: {"error":"No transactions support in neon-http driver","stack":"Error: No transactions support in neon-http driver\n    at NeonHttpSession.transaction (/home/runner/workspace/node_modules/src/neon-http/session.ts:221:9)\n    at NeonHttpDatabase.transaction (/home/runner/workspace/node_modules/src/pg-core/db.ts:636:23)\n    at BiomarkerExtractionService.storeBiomarkers (/home/runner/workspace/server/services/biomarkerExtractionService.ts:801:26)\n    at BiomarkerExtractionService.processLabResult (/home/runner/workspace/server/services/biomarkerExtractionService.ts:1098:20)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async LabSummaryService.summarizeLabResult (/home/runner/workspace/server/services/labSummaryService.ts:104:13)","textLength":2507,"timestamp":"2025-05-20T05:08:44.874Z"}
error: Error processing biomarkers for PDF lab 99: No transactions support in neon-http driver {"stack":"Error: No transactions support in neon-http driver\n    at NeonHttpSession.transaction (/home/runner/workspace/node_modules/src/neon-http/session.ts:221:9)\n    at NeonHttpDatabase.transaction (/home/runner/workspace/node_modules/src/pg-core/db.ts:636:23)\n    at BiomarkerExtractionService.storeBiomarkers (/home/runner/workspace/server/services/biomarkerExtractionService.ts:801:26)\n    at BiomarkerExtractionService.processLabResult (/home/runner/workspace/server/services/biomarkerExtractionService.ts:1098:20)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async LabSummaryService.summarizeLabResult (/home/runner/workspace/server/services/labSummaryService.ts:104:13)","timestamp":"2025-05-20T05:08:44.874Z"}
info: Updated lab result 99 metadata: {"biomarkerCount":19,"hasBiomarkers":true,"parseDate":"2025-05-20T05:08:44.955Z","timestamp":"2025-05-20T05:08:44.955Z"}
info: Successfully parsed PDF for lab result 99 {"hasBiomarkers":true,"textLength":2507,"timestamp":"2025-05-20T05:08:44.955Z"}
info: Created embedding for lab result 99 {"timestamp":"2025-05-20T05:08:59.845Z"}
info: Generated summary for lab result 99 {"timestamp":"2025-05-20T05:08:59.845Z"}
info: Background summary generation comp