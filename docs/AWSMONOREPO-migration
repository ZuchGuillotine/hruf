# StackTracker AWS Migration & Monorepo Transition Plan (Highâ€‘Level)

> **Goal** â€“ Move the live StackTracker web app from Replit to AWS (Elastic Beanstalk + RDS PostgreSQL), while restructuring the codebase into a Turbo/Nx monorepo that will later power iOS & Android builds via Expo. The cutâ€‘over must avoid userâ€‘visible downtime and preserve all current functionality.

---

## Implementation Status (Updated)

### Completed âœ…
1. **AWS Account Setup**
   - Created IAM user with custom policy for infrastructure deployment
   - Configured AWS CLI credentials
   - Bootstrapped CDK environment

2. **Infrastructure as Code (IaC)**
   - Initialized CDK project in `/infra` directory
   - Created VPC infrastructure stack with:
     - Public subnets (10.0.0.0/24, 10.0.1.0/24) for load balancers
     - Private subnets (10.0.2.0/24, 10.0.3.0/24) for application servers
     - Isolated subnets (10.0.4.0/24, 10.0.5.0/24) for databases
     - NAT Gateway for private subnet internet access
     - VPC endpoints for S3, Secrets Manager, and RDS
     - Security groups for database and application tiers

### In Progress ğŸš§
1. **Infrastructure as Code (IaC)**
   - [ ] RDS instance configuration with pgvector
   - [ ] S3 bucket setup for uploads
   - [ ] Elastic Beanstalk environment
   - [ ] Secrets Manager configuration

### Pending â³
1. **Monorepo Restructuring**
   - [ ] Move current code into `apps/web`
   - [ ] Set up shared packages
   - [ ] Configure Turbo tasks

2. **CI/CD Pipeline**
   - [ ] GitHub Actions workflow setup
   - [ ] Docker build configuration
   - [ ] Deployment automation

3. **Data Migration**
   - [ ] Database backup strategy
   - [ ] Migration testing
   - [ ] Cut-over planning

4. **Mobile App Setup**
   - [ ] Expo project initialization
   - [ ] Shared component library
   - [ ] Mobile-specific configurations

---

## 0 Â· Prerequisites & Assumptions

* Small active user base (<100) â‡’ brief readâ€‘only window is acceptable but strive for 0â€‘downtime.
* AWS account, Route 53, and Apple/Google developer accounts are already provisioned.
* Current Postgres data on Replit can be exported with `pg_dump`.
* CI provider is GitHub Actions (can be swapped later).

---

## 1 Â· Branch Strategy

1. **Create longâ€‘lived branch** `migration/aws-monorepo` off `main`.
2. Protect `main`; all prod deploys continue via Replit until final cutâ€‘over.
3. Periodically merge `main` â†’ `migration` to stay up to date.

---

## 2 Â· Infrastructure as Code (IaC)

> **Folder:** `/infra`
> | Stack | Service | Notes |
> |-------|---------|-------|
> | **VPC** | 2 public + 2 private + 2 isolated subnets | âœ… Implemented with proper network segmentation |
> | **DB** | **RDS PostgreSQL 15** | ğŸš§ Pending - Will include pgvector extension |
> | **Compute** | **Elastic Beanstalk (EB)** | ğŸš§ Pending - Docker platform configuration |
> | **Storage** | S3 bucket `stacktrackerâ€‘uploadsâ€‘<env>` | ğŸš§ Pending - Will include versioning and CORS |
> | **Secrets** | AWS Secrets Manager | ğŸš§ Pending - Will store DB creds, API keys |
> | **Monitoring** | CloudWatch Logs + Alarms | â³ Pending - Will monitor EB and RDS |

Use **CloudFormation or AWS CDK** to template the above. Ship a `staging` stack first, followed by `prod`.

---

## 3 Â· Monorepo Scaffolding

```
/
â”œ apps/
â”‚  â”œ web/        # existing Vite/Express app
â”‚  â”” mobile/     # Expo placeholder
â”œ packages/
â”‚  â”œ ui/         # shared RN + web components
â”‚  â”” core/       # api clients, hooks, utils
â”œ infra/         # IaC code
â”œ turbo.json
â”œ package.json   # workspaces
â”” tsconfig.json
```

1. Enable **pnpm or Yarn workspaces**.
2. Add Turbo tasks: `build`, `lint`, `test`, `deploy:web`.
3. Move current code into `apps/web`; fix paths.

---

## 4 Â· Containerization & EB

1. Add multiâ€‘stage **Dockerfile** in `apps/web` (Node 20 Alpine).
2. `Dockerrun.aws.json` for EB or set platform to *Docker*.
3. EB environment variables map â†’ Secrets Manager.
4. Configure EB health check to `/_health`.

---

## 5 Â· CI/CD Pipeline (GitHub Actions)

| Job            | Trigger                | Key Steps                                           |
| -------------- | ---------------------- | --------------------------------------------------- |
| `build-web`    | push â†’ `migration/*`   | Turbo cache â†’ Docker build â†’ push to ECR `staging`. |
| `deploy-web`   | success of `build-web` | Update EB environment via CLI; wait for green.      |
| `db-migrate`   | after deploy           | Run `drizzle-kit push` against RDS.                 |
| `promote-prod` | tag `v*` on `main`     | Same build, deploy to **prod** EB.                  |
| `mobile-build` | onâ€‘demand              | `eas build --platform all` (later phase).           |

---

## 6 Â· Data Migration

1. Put Replit DB in **readâ€‘only** mode.
2. `pg_dump` â†’ `pg_restore` into RDS.
3. Update EB env vars to RDS endpoint; restart.
4. Smokeâ€‘test staging.
5. Reâ€‘enable writes.

---

## 7 Â· Cutâ€‘Over / Production Switch

1. Lower DNS TTL to 60 seconds (24 h prior).
2. Merge `migration` â†’ `main`; pipeline deploys to **prod** EB.
3. Validate ALB health checks, Stripe webhooks.
4. Switch Route 53 record to EB ALB.
5. Monitor logs & metrics for 30 minutes; rollback via previous EB version if needed.

---

## 8 Â· Mobile Rollâ€‘Out (Postâ€‘Migration)

1. Scaffold `apps/mobile` via **Expo TS** template.
2. Consume `packages/ui` components.
3. Configure `.env.*` for API base URL & publishable keys.
4. Integrate Apple/Google signâ€‘in (if required).
5. Build with **EAS Build**; TestFlight & internal testing.
6. Submit to App Store & Play Store.
7. Link store listings to privacy policy (hosted on website).

---

## 9 Â· Risk Mitigation & Rollback

* Keep Replit deployment live until DNS cutâ€‘over.
* Automated snapshots on RDS pre & postâ€‘migration.
* Use EB blue/green deployments for zeroâ€‘downtime swap.
* Featureâ€‘flag any new code paths touching S3 or Redis.

---

## 10 Â· Postâ€‘Migration Hardening

* Enable RDS Multiâ€‘AZ & backups.
* Add WAF to ALB, rateâ€‘limit auth routes.
* Set up daily ECS/EB image scans.
* Expand synthetic monitoring (Pingdom) to global POPs.

---

## ğŸ“‹ Kanâ€‘Ban / Checklist

| Backlog â¡                 | In Progress â¡       | Code Review â¡          | Staging Ready â¡      | Prod Done            |
| ------------------------- | ------------------- | ---------------------- | -------------------- | -------------------- |
| âœ… Create `migration` branch | âœ… IaC VPC + RDS       | âœ… VPC network design     | ğŸš§ DB import dryâ€‘run    | DNS cutâ€‘over         |
| ğŸš§ Monorepo skeleton         | ğŸš§ Dockerfile build OK | ğŸš§ Turbo tasks lint     | Smoke tests pass     | Remove Replit env    |
| ğŸš§ Secrets Manager entries   | ğŸš§ EB staging env      | ğŸš§ EB config ğŸ¯         | Blue/green swap plan | Submit iOS build     |
| â³ GitHub Actions pipeline   | â³ S3 upload refactor  | â³ Drizzle migration CI | User UAT feedback    | Submit Android build |
| â³ Postgres `pg_dump` script |                     |                        |                      |                      |

*(âœ… = Completed, ğŸš§ = In Progress, â³ = Pending)*

---

### Updated Timeline

| Day  | Milestone                                 | Status      |
| ---- | ----------------------------------------- | ----------- |
| 0â€‘1  | Branch + IaC skeleton                     | âœ… Completed |
| 2â€‘4  | Monorepo restructure, Docker build passes | ğŸš§ In Progress |
| 5â€‘6  | EB staging green, data migrated           | â³ Pending   |
| 7    | QA & load test                            | â³ Pending   |
| 8    | Prod cutâ€‘over                             | â³ Pending   |
| 9â€‘14 | Mobile app bootstrap, TestFlight *alpha*  | â³ Pending   |

â€” End of Plan â€”
