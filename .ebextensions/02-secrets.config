Resources:
  # IAM policy to access Google Vision credentials secret
  GoogleVisionSecretsPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: GoogleVisionSecretsAccess
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
              - secretsmanager:DescribeSecret
            Resource: "arn:aws:secretsmanager:us-west-2:881490119784:secret:GOOGLEOCR*"
      Roles:
        - aws-elasticbeanstalk-ec2-role

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_load_google_vision_secret.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      echo "Loading Google Vision credentials from Secrets Manager..."
      
      # Get the secret value
      SECRET_VALUE=$(aws secretsmanager get-secret-value \
        --region us-west-2 \
        --secret-id GOOGLEOCR \
        --query SecretString \
        --output text 2>/dev/null)
      
      if [ $? -eq 0 ] && [ ! -z "$SECRET_VALUE" ]; then
        echo "Successfully retrieved Google Vision credentials"
        # Add to environment file that EB sources
        echo "export GOOGLE_VISION_CREDENTIALS='$SECRET_VALUE'" >> /opt/elasticbeanstalk/deployment/env
      else
        echo "Warning: Failed to retrieve Google Vision credentials from Secrets Manager"
        echo "Application will use fallback credentials"
      fi